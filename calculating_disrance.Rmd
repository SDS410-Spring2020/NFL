---
title: "Calculating_distance"
author: "Aoi Ogawa"
date: "2/28/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
# importing libraries
library(datasets)
library(maps)
library(tidyr)
library(tidyverse)
library(readr)
# install.packages("geosphere")
library(geosphere)
library(dplyr)
library(sp)
library(leaflet)
library(magrittr)
```


```{r, include=FALSE}
# importing data
games<-read.csv("data/games_Smith.csv")
pbp<-read.csv("data/pbp_Smith.csv")
stadium_data_coordinates <- read.csv("stadium_data_coordinates.csv")
visit_team_data <- read.csv("visit_team_data.csv")
ns_data_coordinates <- read.csv("Ns_data_coordinates.csv")
all_data_coordinates <- read.csv("All_data_coordinates.csv")
```

```{r}
games_w_coordinates <- games %>%
  inner_join(stadium_data_coordinates)

games_w_coordinates <- games_w_coordinates %>%
  inner_join(visit_team_data)

games_w_coordinates$num <-NULL
games_w_coordinates$additional_info_location <- NULL
colnames(games_w_coordinates)[colnames(games_w_coordinates) == 'longitude'] <- 'Home_lat'
colnames(games_w_coordinates)[colnames(games_w_coordinates) == 'latitude'] <- 'Home_long'

games_w_coordinates <- games_w_coordinates[!duplicated(games_w_coordinates$GameKey), ]

remove.list <- paste(c('Wembley Stadium',"Rogers Centre","Wembley","Twickenham","Estadio Azteca","Twickenham Stadium","Azteca Stadium","Tottenham Hotspur Stadium","Tottenham Hotspur"), collapse = '|')

domestic_games <- games_w_coordinates %>%
  filter(!grepl(remove.list, Stadium))

domestic_games <- domestic_games[!duplicated(domestic_games$GameKey), ]

international_games <- games_w_coordinates %>%
  filter(grepl(remove.list, Stadium))

international_games <- international_games[!duplicated(international_games$GameKey), ]
```

```{r}
# calculate distance

calc_domestic <- domestic_games %>% 
  rowwise() %>%
  mutate(distance_m = distCosine(c(Home_long, Home_lat),c(Visit_long, Visit_lat))) %>%
  mutate(distance_mile = distance_m*0.6214/1000)

calc_domestic <- calc_domestic[!duplicated(calc_domestic$GameKey), ]

calc_domestic <- calc_domestic %>%
  mutate(distance = ifelse(distance_mile > 2000, "very far",
                           ifelse(distance_mile > 1000 && distance_mile <= 2000, "far", "close"))) %>%
  mutate(color_dis = ifelse(distance == "very far", "red",
                        ifelse(distance == "far", "orange",
                               "cyan")))

# domestic_distance <- calc_domestic %>%
#   group_by(distance) %>%
#   summarise(num =n())

total_dis<-function(year){
  
sum.distance <- calc_domestic %>%
  group_by(Visit_Team,Season) %>%
  summarise(num =sum(distance_mile)) %>%
  filter(Season == year)

  return(sum.distance)
}

total_dis("2018") %>% View()

```

```{r}
#some analysis
# without_season_dis <- calc_domestic %>%
#   group_by(Home_Team,Visit_Team,distance_mile) %>%
#   summarise(num=n())
# 
# season_dis <- calc_domestic %>%
#   group_by(Home_Team,Visit_Team,distance_mile,Season) %>%
#   summarise(num=n())
# 
# season_num_games_home <- calc_domestic %>%
#   group_by(Home_Team,Season) %>%
#   summarise(host_num=n())
# 
# season_num_games_visit <- calc_domestic %>%
#   group_by(Visit_Team,Season) %>%
#   summarise(visit_num=n())

```


```{r}

mapping_travel <-function(season,visit_team){

  season_data <- calc_domestic %>%
  filter(Season== season)
  
mapping_team <-season_data %>%
  filter(Visit_Team == visit_team)

travel_map <- mapping_team %>% 
  leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  setView(-93.65, 42.0285, zoom = 4.3) %>%
  addMarkers(~Visit_long, ~Visit_lat) %>%
  addMarkers(~Home_long, ~Home_lat) %>%
  addMarkers(
    lng = mapping_team$Visit_long, 
    lat = mapping_team$Visit_lat,
    label = mapping_team$Visit_Team,
    labelOptions = labelOptions(noHide = T))

for (i in 1:nrow(mapping_team)){
  
travel_map <- travel_map %>%
  addPolylines(lat=c(mapping_team[i,]$Visit_lat,
                     mapping_team[i,]$Home_lat),
               lng=c(mapping_team[i,]$Visit_long,
                     mapping_team[i,]$Home_long),
              color = mapping_team[i,]$color_dis) %>%
  addMarkers(
    lng = mapping_team[i,]$Home_long,
    lat = mapping_team[i,]$Home_lat,
    label = mapping_team[i,]$Home_Team,
    labelOptions = labelOptions(noHide = T))
}

return(travel_map)

}

mapping_travel("2016","Los Angeles Rams")

```

```{r}
# Is the game on thursday?

thusday_travel <- fulldata_with_thurs %>% 
    left_join(calc_domestic) %>%
  mutate(color_thurs = ifelse(is_thurs == '1', "red","blue"))

mapping_thursday <-function(season,visit_team){

  season_thurs_data <- thusday_travel %>% 
  filter(Season == season)
  
mapping_team_thurs <-season_thurs_data %>%
  filter(Visit_Team == visit_team)

travel_thurs_map <- mapping_team_thurs %>% 
  leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  setView(-93.65, 42.0285, zoom = 4.3) %>%
  addMarkers(~Visit_long, ~Visit_lat) %>%
  addMarkers(~Home_long, ~Home_lat) %>%
  addMarkers(
    lng = mapping_team_thurs$Visit_long, 
    lat = mapping_team_thurs$Visit_lat,
    label = mapping_team_thurs$Visit_Team,
    labelOptions = labelOptions(noHide = T))

for (i in 1:nrow(mapping_team_thurs)){
  
travel_thurs_map <- travel_thurs_map %>%
  addPolylines(lat=c(mapping_team_thurs[i,]$Visit_lat,
                     mapping_team_thurs[i,]$Home_lat),
               lng=c(mapping_team_thurs[i,]$Visit_long,
                     mapping_team_thurs[i,]$Home_long),
              color = mapping_team_thurs[i,]$color_thurs) %>%
  addMarkers(
    lng = mapping_team_thurs[i,]$Home_long,
    lat = mapping_team_thurs[i,]$Home_lat,
    label = mapping_team_thurs[i,]$Home_Team,
    labelOptions = labelOptions(noHide = T))
}

return(travel_thurs_map)

}

mapping_thursday("2016","Los Angeles Rams")

```



